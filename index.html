<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DropLogik GPS Demo</title>
    <!-- Leaflet (OpenStreetMap) CSS and JS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- HTML to Canvas for downloading QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }
      .card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        padding: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      button {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }
      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: transform 0.2s;
        margin-top: 10px;
      }
      button:hover {
        transform: translateY(-2px);
      }
      .result {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      
      /* Responsive Design */
      @media (max-width: 768px) {
        .grid {
          grid-template-columns: 1fr; /* Single column on mobile */
          gap: 15px;
        }
        
        .container {
          padding: 10px;
        }
        
        .card {
          margin: 10px 0;
        }
        
        input, button {
          font-size: 16px; /* Prevent zoom on iOS */
        }
        
        #map {
          height: 300px !important; /* Smaller map on mobile */
        }
      }
      
      /* QR Code Responsive Styling */
      #qrCodeCanvas {
        max-width: 100% !important;
        height: auto !important;
      }
      
      #qrCodeCanvas img,
      #qrCodeCanvas canvas {
        max-width: 100% !important;
        height: auto !important;
        border-radius: 8px;
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .coords-display {
        background: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      #map {
        height: 400px;
        width: 100%;
        border-radius: 10px;
        margin: 10px 0;
      }
      .map-instructions {
        background: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        font-size: 14px;
      }
      .coordinates-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin: 10px 0;
      }
      .coord-box {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
      }
      .coord-box.corrected {
        border-left-color: #28a745;
      }
      
      /* New Clean Design Styles */
      .map-instructions {
        background: #e8f4fd;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin: 15px 0;
        border-radius: 5px;
        font-size: 14px;
      }
      
      .coordinate-display {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border: 1px solid #dee2e6;
      }
      
      .coordinate-display div {
        margin: 8px 0;
        font-size: 14px;
      }
      
      .register-btn {
        background: #28a745 !important;
        font-size: 16px;
        padding: 12px 24px;
        margin: 15px 0;
      }
      
      .register-btn:hover {
        background: #218838 !important;
      }
      
      #addressSection {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        border: 1px solid #dee2e6;
      }
      
      #addressSection small {
        display: block;
        margin-top: 5px;
        font-style: italic;
      }
      
      /* Additional Mobile Optimizations */
      @media (max-width: 480px) {
        .coordinate-display {
          padding: 10px;
          font-size: 13px;
        }
        
        .coordinate-display div {
          margin: 6px 0;
          word-break: break-all; /* Handle long coordinates */
        }
        
        .map-instructions {
          padding: 10px;
          font-size: 13px;
        }
        
        .register-btn {
          padding: 10px 20px;
          font-size: 14px;
        }
        
        /* Admin section mobile optimization */
        #adminSection .card {
          padding: 15px;
        }
        
        #adminSection input {
          margin-bottom: 10px;
        }
        
        /* Result displays */
        .result {
          font-size: 11px;
          max-height: 200px;
          padding: 10px;
        }
        
        /* QR Code download button */
        button[onclick="downloadQR()"] {
          padding: 10px 16px;
          font-size: 14px;
          margin-top: 10px;
        }
      }
      
      /* Admin Section Desktop Layout */
      @media (min-width: 769px) {
        /* Make admin section full width instead of using grid */
        #adminSection .grid {
          grid-template-columns: 1fr; /* Single column to use full width */
        }
        
        #adminSection .card {
          max-width: none; /* Remove width restrictions */
        }
        
        /* Location Lookup internal layout */
        .lookup-section {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 30px;
          margin: 20px 0;
        }
        
        .lookup-group {
          display: flex;
          flex-direction: column;
        }
        
        .lookup-group .form-group {
          margin-bottom: 15px;
        }
        
        .lookup-group button {
          margin-top: auto; /* Push button to bottom of its column */
          align-self: flex-start;
          width: auto;
          min-width: 200px;
        }
        
        /* Result section spans full width */
        .lookup-result-full {
          grid-column: 1 / -1;
          margin-top: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìç DropLogik GPS Demo</h1>
        <p>Precision Location System for Delivery Drops</p>
      </div>

      <!-- Authentication Section -->
      <div class="card" id="authCard">
        <h3>üîê Authentication Required</h3>
        <p>Please login to access GPS features:</p>
        <div class="form-group">
          <label for="email">Email:</label>
          <input
            type="email"
            id="email"
            placeholder="Enter your email"
            value="team@blocklogik.com"
          />
        </div>
        <div class="form-group">
          <label for="password">Password:</label>
          <input
            type="password"
            id="password"
            placeholder="Enter password"
          />
        </div>
        <button onclick="login()" class="btn-primary">Login</button>
        <div id="authStatus"></div>
        <div
          style="
            margin-top: 15px;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 5px;
          "
        >
          <h4>Demo Accounts:</h4>
          <p><strong>Admin:</strong> team@blocklogik.com</p>
          <p><strong>Test User:</strong> user@droplogik.com (password: User123!@#)</p>
          <p><strong>Test Partner:</strong> partner@droplogik.com (password: Partner123!@#)</p>
          <p><strong>Your Account:</strong> philip.polo@yahoo.com</p>
        </div>
      </div>

      <!-- GPS Demo Section (hidden until logged in) -->
      <div id="gpsDemo" style="display: none">
        <!-- Main GPS Map Interface -->
        <div class="card">
          <h3>üó∫Ô∏è GPS Location Registration</h3>
          <div class="map-instructions">
            <strong>Simple 3-step process:</strong><br>
            1Ô∏è‚É£ Click "Show Map & Get My Location" below<br>
            2Ô∏è‚É£ Drag the green marker to your exact location<br>
            3Ô∏è‚É£ Add optional address details and register
          </div>

          <div class="form-group">
            <label>User ID:</label>
            <input
              type="text"
              id="mapUserId"
              value="demo_user_123"
              placeholder="Enter user ID"
            />
          </div>

          <button onclick="initializeMap()">
            üó∫Ô∏è Show Map & Get My Location
          </button>

          <!-- Address field (appears after map loads) -->
          <div id="addressSection" style="display: none">
            <div class="form-group">
              <label>Address/Description (optional):</label>
              <input
                type="text"
                id="mapAddress"
                placeholder="e.g., My office, John's house, Delivery point A"
              />
              <small style="color: #666;">Help others identify this location</small>
            </div>
          </div>

          <div id="mapContainer">
            <div id="map" style="height: 400px; width: 100%; margin: 20px 0;"></div>
            
            <!-- Map Controls (appears after map loads) -->
            <div id="mapControls" style="display: none">
              <div class="coordinate-display">
                <div><strong>üìç GPS Location:</strong> <span id="originalCoords">-</span></div>
                <div><strong>‚úÖ Corrected Location:</strong> <span id="correctedCoords">-</span></div>
                <div><strong>üìè Correction Distance:</strong> <span id="correctionDistance">0m</span></div>
              </div>
              
              <button onclick="registerCorrectedLocation()" class="register-btn">
                üìç Register This Location
              </button>
              
              <div id="mapResult"></div>
            </div>
          </div>
        </div>

        <!-- Admin-Only Section -->
        <div id="adminSection" style="display: none">
          <div class="grid">
            <!-- Location Lookup (Admin Only) -->
            <div class="card">
              <h3>ÔøΩ Location Lookup (Admin)</h3>
              <div class="lookup-section">
                <!-- Location ID Lookup -->
                <div class="lookup-group">
                  <div class="form-group">
                    <label>Location ID:</label>
                    <input type="text" id="locationId" placeholder="Enter location ID" />
                  </div>
                  <button onclick="getLocation()">üîç Look Up Location</button>
                </div>
                
                <!-- User Location History -->
                <div class="lookup-group">
                  <div class="form-group">
                    <label>User ID for Location History:</label>
                    <input type="text" id="lookupUserId" placeholder="Enter user ID" />
                  </div>
                  <button onclick="getUserLocations()">üìã Get User's Locations</button>
                </div>
                
                <!-- Results section spans full width -->
                <div class="lookup-result-full">
                  <div id="lookupResult"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

    <script>
      const API_BASE = window.location.origin;

      // Get user's current location
      function getCurrentLocation() {
        if (navigator.geolocation) {
          showStatus("Getting your location...", "info");
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              const accuracy = position.coords.accuracy;

              document.getElementById("latitude").value = lat;
              document.getElementById("longitude").value = lng;
              document.getElementById("enhanceLat").value = lat;
              document.getElementById("enhanceLng").value = lng;

              document.getElementById("currentPosition").innerHTML = `
                            <strong>Your Current Location:</strong><br>
                            Latitude: ${lat}<br>
                            Longitude: ${lng}<br>
                            Accuracy: ¬±${accuracy} meters<br>
                            <small>Timestamp: ${new Date().toLocaleString()}</small>
                        `;

              showStatus("Location obtained successfully!", "success");
            },
            (error) => {
              showStatus(`Error getting location: ${error.message}`, "error");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
          );
        } else {
          showStatus("Geolocation is not supported by this browser", "error");
        }
      }

      // Enhance GPS precision
      async function enhancePrecision() {
        const latitude = parseFloat(
          document.getElementById("enhanceLat").value
        );
        const longitude = parseFloat(
          document.getElementById("enhanceLng").value
        );
        const region = document.getElementById("region").value;

        if (!latitude || !longitude) {
          showStatus(
            "Please enter latitude and longitude for enhancement",
            "error"
          );
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/gps/enhance-precision`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
            body: JSON.stringify({ latitude, longitude, region }),
          });

          const result = await response.json();

          if (result.success) {
            document.getElementById("enhanceResult").innerHTML = `
                        <div class="result">
Original: ${result.original.latitude}, ${result.original.longitude}
Formatted: ${result.formatted.formatted}
DMS: ${result.formatted.dms.latitude} ${result.formatted.dms.longitude}

Precision Grid (1m accuracy):
${result.precisionGrid
  .map(
    (p) =>
      `${p.gridPosition}: ${p.lat.toFixed(6)}, ${p.lng.toFixed(6)} ${
        p.isCenter ? "(CENTER)" : ""
      }`
  )
  .join("\n")}

Suggestions:
${result.suggestions
  .map(
    (s) =>
      `${s.reason}: ${s.adjustedLat}, ${s.adjustedLng} (${(
        s.confidence * 100
      ).toFixed(0)}% confidence)`
  )
  .join("\n")}

Location Hash: ${result.locationHash}
                        </div>
                    `;
          } else {
            showStatus(`Enhancement failed: ${result.error}`, "error");
          }
        } catch (error) {
          showStatus(`Error: ${error.message}`, "error");
        }
      }

      // Get location by ID
      async function getLocation() {
        const locationId = document.getElementById("locationId").value;

        if (!locationId) {
          showStatus("Please enter a location ID", "error");
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE}/gps/location/${locationId}`,
            {
              headers: getAuthHeaders(),
            }
          );
          const result = await response.json();

          if (result.success) {
            document.getElementById("lookupResult").innerHTML = `
                        <div class="result">
${JSON.stringify(result.location, null, 2)}
                        </div>
                    `;
          } else {
            showStatus("Location not found", "error");
          }
        } catch (error) {
          showStatus(`Error: ${error.message}`, "error");
        }
      }

      // Get user's locations
      async function getUserLocations() {
        const userId = document.getElementById("lookupUserId").value;

        if (!userId) {
          showStatus("Please enter a user ID", "error");
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE}/gps/user/${userId}/locations`,
            {
              headers: getAuthHeaders(),
            }
          );
          const result = await response.json();

          if (result.success) {
            document.getElementById("lookupResult").innerHTML = `
                        <div class="result">
User: ${result.userId}
Total Locations: ${result.totalLocations}

Locations:
${JSON.stringify(result.locations, null, 2)}
                        </div>
                    `;
          } else {
            showStatus("No locations found for user", "error");
          }
        } catch (error) {
          showStatus(`Error: ${error.message}`, "error");
        }
      }

      // Google Maps Integration
      let map;
      let originalMarker;
      let correctedMarker;
      let originalPosition = null;
      let correctedPosition = null;

      // Initialize the interactive map
      function initializeMap() {
        if (navigator.geolocation) {
          showStatus("Getting your location for map...", "info");
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;

              originalPosition = { lat: lat, lng: lng };
              correctedPosition = { lat: lat, lng: lng }; // Start with same position

              // Initialize Leaflet map with OpenStreetMap
              map = L.map("map").setView([lat, lng], 18);

              // Add OpenStreetMap tile layer
              L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {
                  attribution: "¬© OpenStreetMap contributors",
                  maxZoom: 19,
                }
              ).addTo(map);

              // Add satellite/imagery layer option
              const satellite = L.tileLayer(
                "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                {
                  attribution:
                    "Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community",
                }
              );

              // Layer control to switch between map types
              const baseMaps = {
                OpenStreetMap: L.tileLayer(
                  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                ),
                Satellite: satellite,
              };
              L.control.layers(baseMaps).addTo(map);

              // Create custom icons
              const redIcon = L.icon({
                iconUrl:
                  "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
                shadowUrl:
                  "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41],
              });

              const greenIcon = L.icon({
                iconUrl:
                  "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
                shadowUrl:
                  "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41],
              });

              // Add original position marker (red, non-draggable)
              originalMarker = L.marker([lat, lng], {
                icon: redIcon,
                title: "GPS Detected Location",
              }).addTo(map);
              originalMarker
                .bindPopup(
                  "üìç GPS Detected Location<br>This is where your device thinks you are"
                )
                .openPopup();

              // Add corrected position marker (green, draggable)
              correctedMarker = L.marker([lat, lng], {
                icon: greenIcon,
                draggable: true,
                title: "Drag me to your actual location",
              }).addTo(map);
              correctedMarker.bindPopup("üéØ Drag me to your actual location");

              // Update coordinates when marker is dragged
              correctedMarker.on("dragend", function (e) {
                const position = e.target.getLatLng();
                correctedPosition = {
                  lat: position.lat,
                  lng: position.lng,
                };
                updateCoordinateDisplay();
              });

              updateCoordinateDisplay();
              
              // Show address section and map controls after map loads
              document.getElementById("addressSection").style.display = "block";
              document.getElementById("mapControls").style.display = "block";
              
              showStatus(
                "Map loaded! Drag the green marker to correct your location.",
                "success"
              );
            },
            (error) => {
              showStatus(
                `Error getting location for map: ${error.message}`,
                "error"
              );
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
          );
        } else {
          showStatus("Geolocation is not supported by this browser", "error");
        }
      }

      // Update coordinate display
      function updateCoordinateDisplay() {
        if (originalPosition) {
          document.getElementById(
            "originalCoords"
          ).innerHTML = `${originalPosition.lat.toFixed(
            6
          )}, ${originalPosition.lng.toFixed(6)}`;
        }
        if (correctedPosition) {
          document.getElementById(
            "correctedCoords"
          ).innerHTML = `${correctedPosition.lat.toFixed(
            6
          )}, ${correctedPosition.lng.toFixed(6)}`;

          // Calculate and display distance between original and corrected
          if (originalPosition) {
            const distance = calculateDistance(
              originalPosition.lat,
              originalPosition.lng,
              correctedPosition.lat,
              correctedPosition.lng
            );
            document.getElementById(
              "correctionDistance"
            ).innerHTML = `${distance.toFixed(1)}m`;
          }
        }
      }

      // Calculate distance between two points (Haversine formula)
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Earth's radius in meters
        const œÜ1 = (lat1 * Math.PI) / 180;
        const œÜ2 = (lat2 * Math.PI) / 180;
        const ŒîœÜ = ((lat2 - lat1) * Math.PI) / 180;
        const ŒîŒª = ((lon2 - lon1) * Math.PI) / 180;

        const a =
          Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
          Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        return R * c;
      }

      // Register the corrected location
      async function registerCorrectedLocation() {
        if (!correctedPosition || !originalPosition) {
          showStatus("Please initialize the map first", "error");
          return;
        }

        const userId = document.getElementById("mapUserId").value;
        const userAddress = document.getElementById("mapAddress").value;
        
        if (!userId) {
          showStatus("Please enter a user ID", "error");
          return;
        }

        // Create address with user input + correction info
        const correctionDistance = calculateDistance(
          originalPosition.lat,
          originalPosition.lng,
          correctedPosition.lat,
          correctedPosition.lng
        );
        
        let finalAddress = userAddress || "GPS Location";
        if (correctionDistance > 1) {
          finalAddress += ` (${correctionDistance.toFixed(1)}m correction applied)`;
        }

        try {
          const response = await fetch(`${API_BASE}/gps/register`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...getAuthHeaders(),
            },
            body: JSON.stringify({
              userId: userId,
              latitude: originalPosition.lat,
              longitude: originalPosition.lng,
              correctedLatitude: correctedPosition.lat,
              correctedLongitude: correctedPosition.lng,
              address: finalAddress,
            }),
          });

          const result = await response.json();

          if (result.success) {
            const correctionDistance = calculateDistance(
              originalPosition.lat,
              originalPosition.lng,
              correctedPosition.lat,
              correctedPosition.lng
            );

            // Create QR code data with Google Maps directions URL
            const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${correctedPosition.lat},${correctedPosition.lng}`;
            const qrData = mapUrl;

            document.getElementById("mapResult").innerHTML = `
              <div class="status success">
                <strong>‚úÖ Location Registered Successfully!</strong><br><br>
                
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin: 10px 0;">
                  <strong>üìç Location Details:</strong><br>
                  <small>Location ID: ${result.locationId}</small><br>
                  <small>Correction: ${correctionDistance.toFixed(
                    1
                  )} meters from GPS</small><br>
                  <small>QR Code: ${result.qrCode}</small>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                  <strong>üì± Delivery QR Code:</strong><br>
                  <small style="color: #666;">Scan to open Google Maps with driving directions to this location</small><br>
                  <div id="qrCodeCanvas" style="margin: 10px auto; border: 2px solid #ddd; border-radius: 8px; display: inline-block; max-width: 100%; overflow: hidden;"></div><br>
                  <button onclick="downloadQR()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                    üì• Download QR Code
                  </button>
                </div>
              </div>
            `;

            // Generate and display QR code
            const qrElement = document.getElementById("qrCodeCanvas");

            try {
              // Clear any existing QR code
              qrElement.innerHTML = "";
              
              // Calculate responsive QR code size
              const screenWidth = window.innerWidth;
              let qrSize = 200; // Default size
              
              if (screenWidth < 480) {
                qrSize = Math.min(180, screenWidth - 80); // Small phones
              } else if (screenWidth < 768) {
                qrSize = 200; // Tablets
              }
              
              // Generate new QR code with responsive sizing
              new QRCode(qrElement, {
                text: qrData,
                width: qrSize,
                height: qrSize,
                colorDark: "#000000",
                colorLight: "#FFFFFF",
                correctLevel: QRCode.CorrectLevel.H,
              });
              console.log("QR code generated successfully");
            } catch (error) {
              console.error("QR code generation failed:", error);
              // Fallback to text
              qrElement.style.display = "none";
              const fallbackDiv = document.createElement("div");
              fallbackDiv.innerHTML = `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 10px; margin: 10px 0;">
                  <strong>üì± Map Link:</strong><br>
                  <small style="word-break: break-all; font-family: monospace;">${qrData}</small><br>
                  <small style="color: #856404;">üí° Copy this link and use any online QR generator to create your delivery QR code!</small>
                </div>
              `;
              qrElement.parentNode.appendChild(fallbackDiv);
            }
          } else {
            showStatus(`Registration failed: ${result.error}`, "error");
          }
        } catch (error) {
          showStatus(`Error: ${error.message}`, "error");
        }
      }

      // Show status message
      function showStatus(message, type) {
        const statusDiv = document.createElement("div");
        statusDiv.className = `status ${type}`;
        statusDiv.textContent = message;

        // Remove existing status messages
        const existingStatus = document.querySelector(".status");
        if (existingStatus) {
          existingStatus.remove();
        }

        document.getElementById("mapResult").appendChild(statusDiv);
      }

      // Download QR code function
      async function downloadQR() {
        const qrElement = document.getElementById("qrCodeCanvas");
        try {
          const canvas = await html2canvas(qrElement);
          const link = document.createElement("a");
          link.download = "delivery-qr-code.png";
          link.href = canvas.toDataURL();
          link.click();
        } catch (error) {
          console.error("Failed to download QR code:", error);
          alert("Failed to download QR code. Please try again.");
        }
      }

      // Initialize with some sample data
      window.onload = function () {
        // Set default value for map user ID
        const mapUserIdElement = document.getElementById("mapUserId");
        if (mapUserIdElement) {
          mapUserIdElement.value = "demo_user_" + Date.now();
        }

        // Check which QR libraries loaded
        if (typeof QRCode !== "undefined") {
          console.log("‚úÖ QRCode library loaded successfully");
        } else {
          console.warn(
            "‚ö†Ô∏è QRCode library not loaded. QR codes will show as text."
          );
        }
      };

      // Authentication functions
      let authToken = "";

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const statusDiv = document.getElementById("authStatus");

        if (!email || !password) {
          statusDiv.innerHTML =
            '<div style="color: red;">Please enter email and password</div>';
          return;
        }

        try {
          statusDiv.innerHTML = '<div style="color: blue;">Logging in...</div>';

          const response = await fetch("/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            authToken = result.token;
            statusDiv.innerHTML =
              '<div style="color: green;">‚úÖ Login successful!</div>';

            // Hide auth card and show GPS demo
            document.getElementById("authCard").style.display = "none";
            document.getElementById("gpsDemo").style.display = "block";

            // Show admin section only for admin users
            if (result.user && result.user.role === 'admin') {
              document.getElementById("adminSection").style.display = "block";
            }

            console.log("Logged in as:", result.user);
          } else {
            statusDiv.innerHTML = `<div style="color: red;">‚ùå Login failed: ${
              result.error || "Invalid credentials"
            }</div>`;
          }
        } catch (error) {
          console.error("Login error:", error);
          statusDiv.innerHTML =
            '<div style="color: red;">‚ùå Connection error. Please try again.</div>';
        }
      }

      // Update all fetch requests to include authentication header
      function getAuthHeaders() {
        if (!authToken) {
          return {};
        }
        return {
          Authorization: `Bearer ${authToken}`,
        };
      }
    </script>
  </body>
</html>
