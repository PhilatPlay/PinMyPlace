<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dropLogik - Instant GPS Pin for Deliveries</title>

    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#0000ff">
    <link rel="apple-touch-icon" href="/pics/pwa/icon-192.png">
    <link rel="icon" href="/pics/pwa/icon-512.png" sizes="512x512" type="image/png">
    <link rel="icon" href="/pics/pwa/icon-192.png" sizes="192x192" type="image/png">

    <!-- External CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />

    <!-- External JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header">
        <div style="text-align: left; margin-bottom: 20px;">
          <a href="/" style="display: inline-block;">
            <img src="/pics/dropLogik-logo.png" alt="dropLogik Logo" style="width: 180px; height: auto; background: transparent;">
          </a>
        </div>
        <p id="headerPrice">
          Digital Addressing for Reliable Delivery -- create a scannable location for areas without formal addresses.
        </p>
        <!-- Auth link hidden for now -->
      </div>

      <!-- Main Pin Creation Section (No Login Required) -->
      <div id="mainPinSection">
        <!-- Currency Selector -->
        <div class="card" style="background: #f8f9fa; padding: 15px;">
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
            <div style="flex: 1; min-width: 200px;">
              <label style="display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px;">ğŸ’± Select Currency:</label>
              <select id="homeCurrencySelect" onchange="updateHomeCurrency()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; width: 100%; font-size: 14px;">
                <option value="PHP">ğŸ‡µğŸ‡­ Philippine Peso (â‚±)</option>
                <option value="MYR">ğŸ‡²ğŸ‡¾ Malaysian Ringgit (RM)</option>
                <option value="SGD">ğŸ‡¸ğŸ‡¬ Singapore Dollar (S$)</option>
                <option value="THB">ğŸ‡¹ğŸ‡­ Thai Baht (à¸¿)</option>
                <option value="IDR">ğŸ‡®ğŸ‡© Indonesian Rupiah (Rp)</option>
                <option value="VND">ğŸ‡»ğŸ‡³ Vietnamese Dong (â‚«)</option>
                <option value="HKD">ğŸ‡­ğŸ‡° Hong Kong Dollar (HK$)</option>
                <option value="USD">ğŸŒ US Dollar ($)</option>
              </select>
            </div>
            <div style="font-size: 13px; color: #666; flex: 1; min-width: 200px;">
              ğŸ’¡ Prices shown in your selected currency<br>
              <a href="/bulk-purchase.html" style="color: #007bff; text-decoration: underline;">ğŸ“¦ Buy codes in bulk</a> - Get wholesale discounts!
            </div>
          </div>
        </div>

        <!-- How It Works -->
        <div
          class="card"
          style="background: #e8f4fd; border-left: 4px solid #007bff"
        >
          <h3>ğŸ¯ How It Works (3 Easy Steps)</h3>
          <ol style="margin: 15px 0; padding-left: 20px; line-height: 1.8">
            <li>
              <strong>Pin Your Location</strong> - Drag the green marker to your location or preferred  delivery location.
            </li>
            <li>
              <strong>Pay <span class="dynamic-price">â‚±150</span></strong> -
              GCash, Maya, GrabPay, or Card
            </li>
            <li>
              <strong>Get Your QR Code</strong> - Share with delivery services
              instantly!
            </li>
          </ol>
          <p style="margin-top: 15px; color: #666">
            âœ… No registration needed &nbsp; | &nbsp; âœ… Pay with wallet or card
            &nbsp;
          </p>
        </div>

        <!-- Main GPS Map Interface -->
        <div class="card">
          <h3 style="margin-bottom: 20px;">ğŸ“ Step 1: Pin Your Exact Location</h3>

          <div class="form-group">
            <label>Your Name/Location Label:</label>
            <input
              type="text"
              id="locationName"
              name="location-label"
              placeholder="e.g., river camp site, beach hut, fishing spot 1"
              autocomplete="off"
            />
            <small style="color: #666"
              >This helps you identify this pin later</small
            >
          </div>

          <!-- Address field -->
          <div id="addressSection">
            <div class="form-group">
              <label
                >Street Name/Landmarks/ Floor in building (optional):</label
              >
              <input
                type="text"
                id="mapAddress"
                name="address-details"
                placeholder="e.g., on the 3rd floor # 302, entrance to building facing Jollibee."
                autocomplete="off"
                data-form-type="other"
              />
              <small style="color: #666"
                >Help delivery services find you easier</small
              >
            </div>
          </div>

          <div id="mapContainer" style="position: relative">
            <div id="map"></div>

            <!-- Map Controls -->
            <div id="mapControls">
              <div
                style="
                  background: #fff3cd;
                  padding: 15px;
                  border-radius: 8px;
                  margin-bottom: 15px;
                "
              >
                <strong>âš ï¸ Verify Your Location</strong>
                <p style="margin: 5px 0; font-size: 14px">
                  Drag the green marker to your location or preferred  delivery location. Once
                  you pay, you'll get the shareable QR code.
                </p>
                <p style="margin: 5px 0; font-size: 13px; color: #856404">
                  <strong>ğŸ”’ Security:</strong> GPS coordinates and QR code are
                  only revealed after payment verification.
                </p>
              </div>

              <button
                onclick="proceedToPayment()"
                class="register-btn"
                style="background: #28a745 !important"
              >
                ğŸ’° Next: Pay <span class="dynamic-price">â‚±100</span> & Get QR
                Code â†’
              </button>

              <div
                style="
                  text-align: center;
                  margin-top: 10px;
                  font-size: 12px;
                  color: #666;
                "
              >
                <div>
                  ğŸ’³ Accepts: <strong>GCash â€¢ Maya â€¢ GrabPay â€¢ Cards</strong>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Section (appears after pin is set) -->
        <div class="card" id="paymentSection" style="display: none">
          <h3>ğŸ’³ Step 2: Complete Your Pin</h3>
          
          <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
            <small style="color: #666;">Reference Number: <strong id="paymentRefNumber">-</strong></small>
          </div>
          
          <!-- Payment Method Selection -->
          <div style="margin-bottom: 20px; text-align: center;">
            <button 
              id="paymentModeBtn" 
              onclick="showPaymentMode()"
              style="padding: 10px 20px; margin: 5px; border: 2px solid #007bff; background: #007bff; color: white; border-radius: 8px; cursor: pointer; font-size: 16px;"
            >
              ğŸ’³ Pay Now (<span class="dynamic-price">â‚±100</span>)
            </button>
            <button 
              id="codeModeBtn" 
              onclick="showCodeMode()"
              style="padding: 10px 20px; margin: 5px; border: 2px solid #28a745; background: white; color: #28a745; border-radius: 8px; cursor: pointer; font-size: 16px;"
            >
              ğŸ« I Have an Access Code
            </button>
          </div>

          <!-- Payment Mode -->
          <div id="paymentMode">
            <p style="color: #666; margin-bottom: 20px">
              Available payment methods: GCash, Maya (PayMaya), GrabPay, or
              Credit/Debit Card
            </p>

          <div class="form-group">
            <label>Select Currency:</label>
            <select
              id="currencySelect"
              onchange="updatePaymentAmount()"
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 16px;
              "
            >
              <option value="PHP">ğŸ‡µğŸ‡­ Philippine Peso (â‚±100)</option>
              <option value="MYR">ğŸ‡²ğŸ‡¾ Malaysian Ringgit (RM15)</option>
              <option value="SGD">ğŸ‡¸ğŸ‡¬ Singapore Dollar (S$4.5)</option>
              <option value="THB">ğŸ‡¹ğŸ‡­ Thai Baht (à¸¿105)</option>
              <option value="IDR">ğŸ‡®ğŸ‡© Indonesian Rupiah (Rp48,000)</option>
              <option value="VND">ğŸ‡»ğŸ‡³ Vietnamese Dong (â‚«75,000)</option>
              <option value="USD">ğŸŒ US Dollar ($3)</option>
            </select>
            <small style="color: #666">
              Select your preferred currency (prices are equivalent to ~$3 USD)
            </small>
          </div>

          <div class="form-group">
            <label>Your Mobile Number:</label>
            <input
              type="tel"
              id="customerPhone"
              placeholder="+60123456789 or 09171234567"
            />
            <small style="color: #666">
              For verification and notifications (include country code if
              outside PH)
            </small>
          </div>

          <!-- Terms of Service Agreement -->
          <div
            style="
              margin: 20px 0;
              padding: 15px;
              background: #f8f9fa;
              border-radius: 8px;
              border: 1px solid #dee2e6;
            "
          >
            <label
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
                font-size: 14px;
                line-height: 1.6;
              "
            >
              <input
                type="checkbox"
                id="tosCheckbox"
                style="
                  flex-shrink: 0;
                  cursor: pointer;
                  width: 18px;
                  height: 18px;
                "
                onchange="updatePayButtonState()"
              />
              <span style="color: #333"
                >I have read and agree to the
                <a
                  href="/terms-of-service.html"
                  target="_blank"
                  style="color: #667eea; text-decoration: underline"
                  >Terms of Service</a
                >,
                <a
                  href="/privacy-policy.html"
                  target="_blank"
                  style="color: #667eea; text-decoration: underline"
                  >Privacy Policy</a
                >, and
                <a
                  href="/disclaimer.html"
                  target="_blank"
                  style="color: #667eea; text-decoration: underline"
                  >Liability Disclaimer</a
                >.</span
              >
            </label>
          </div>

          <button
            onclick="proceedToGCashPayment()"
            class="register-btn"
            id="payButton"
            disabled
            style="opacity: 0.5; cursor: not-allowed"
          >
            ğŸ’° Pay <span id="paymentAmount">â‚±100</span> Now
          </button>

          <div
            style="
              text-align: center;
              margin: 15px 0;
              padding: 12px;
              background: #f8f9fa;
              border-radius: 8px;
              border: 1px solid #dee2e6;
            "
          >
            <div style="color: #666; font-size: 12px; margin-bottom: 8px">
              ğŸ’³ Accepted Payment Methods:
            </div>
            <div
              style="
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 20px;
                flex-wrap: wrap;
                font-weight: 600;
                font-size: 14px;
              "
            >
              <span style="color: #007aff">ğŸ’™ GCash</span>
              <span style="color: #00d632">ğŸ’š Maya</span>
              <span style="color: #00b14f">ğŸŸ¢ GrabPay</span>
              <span style="color: #6c757d">ğŸ’³ Cards</span>
            </div>
          </div>

          <div id="paymentResult"></div>
        </div>
        
        <!-- Access Code Mode -->
        <div class="card" id="codeModeCard" style="display: none;">
          <h3>ğŸ« Use Access Code</h3>
          <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
            <strong>Redeem Your Access Code</strong>
            <p style="margin: 5px 0; font-size: 14px; color: #084298;">
              Enter your bulk purchase access code to create your pin instantly - no payment needed!
            </p>
          </div>

          <div class="form-group">
            <label>Access Code:</label>
            <input
              type="text"
              id="accessCode"
              placeholder="DL-XXXXXXXX"
              style="text-transform: uppercase; font-family: 'Courier New', monospace; font-size: 18px;"
            />
            <small style="color: #666">
              Enter the code you received from your bulk purchase
            </small>
          </div>

          <div class="form-group">
            <label>Your Mobile Number:</label>
            <input
              type="tel"
              id="codeCustomerPhone"
              placeholder="+60123456789 or 09171234567"
            />
            <small style="color: #666">
              For verification and to link this pin to you
            </small>
          </div>

          <button
            onclick="createPinWithCode()"
            class="register-btn"
            style="background: #28a745 !important"
          >
            âœ… Create Pin with Code
          </button>

          <div style="text-align: center; margin-top: 15px;">
            <a href="/bulk-purchase.html" style="color: #007bff; text-decoration: underline; font-size: 14px;">
              Don't have a code? Buy in bulk (10+ codes at â‚±50-75 each)
            </a>
          </div>
        </div>

        <!-- QR Code Result (appears after payment verified) -->
        <div class="card" id="qrSection" style="display: none">
          <div class="status success">
            <h3>ğŸ‰ Success! Your Location is Pinned!</h3>
            <p>
              Here's your delivery QR code. Save it and share with delivery
              riders!
            </p>
          </div>

          <div
            style="
              background: #f8f9fa;
              border-radius: 8px;
              padding: 20px;
              margin: 15px 0;
              text-align: center;
            "
          >
            <div id="qrDetails" style="margin-bottom: 15px"></div>

            <div
              id="qrCodeCanvas"
              style="margin: 20px auto; display: inline-block"
            ></div>

            <div style="margin-top: 20px">
              <button
                onclick="downloadQR()"
                style="
                  background: #28a745;
                  width: auto;
                  padding: 12px 30px;
                  margin: 5px;
                "
              >
                ğŸ“¥ Download QR Code
              </button>
              <button
                onclick="shareQR()"
                style="
                  background: #007bff;
                  width: auto;
                  padding: 12px 30px;
                  margin: 5px;
                "
              >
                ğŸ“¤ Share via Messenger
              </button>
            </div>

            <div
              style="
                margin-top: 20px;
                padding: 15px;
                background: white;
                border-radius: 8px;
                border: 1px solid #ddd;
              "
            >
              <strong>ğŸ“± Or share this link:</strong><br />
              <input
                type="text"
                id="shareLink"
                readonly
                style="margin-top: 10px; font-size: 12px"
              />
              <button
                onclick="copyShareLink()"
                style="width: auto; padding: 8px 20px; margin-top: 10px"
              >
                ğŸ“‹ Copy Link
              </button>
            </div>
          </div>

          <div
            style="
              background: #fff3cd;
              padding: 15px;
              border-radius: 8px;
              margin: 15px 0;
            "
          >
            <strong>ğŸ’¡ How to Use Your QR Code:</strong>
            <ul style="margin: 10px 0; padding-left: 20px">
              <li>Show this QR to delivery riders when ordering</li>
              <li>They scan it to get GPS directions to your exact location</li>
            </ul>
          </div>

          <button onclick="createAnotherPin()" style="background: #667eea">
            ğŸ“ Create Another Pin
          </button>
        </div>

      </div>
      <!-- End Main Pin Section -->

      <!-- Access Code QR Result (separate from payment flow) -->
      <div class="card" id="codeQrSection" style="display: none">
        <div class="status success">
          <h3>ğŸ‰ Access Code Redeemed!</h3>
          <p>Hereâ€™s your delivery QR code. Save it and share with riders!</p>
        </div>

        <div
          style="
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
          "
        >
          <div id="codeQrDetails" style="margin-bottom: 15px"></div>

          <div
            id="codeQrCanvas"
            style="margin: 20px auto; display: inline-block"
          ></div>

          <div style="margin-top: 20px">
            <button
              onclick="downloadQR()"
              style="
                background: #28a745;
                width: auto;
                padding: 12px 30px;
                margin: 5px;
              "
            >
              ğŸ“¥ Download QR Code
            </button>
            <button
              onclick="shareQR()"
              style="
                background: #007bff;
                width: auto;
                padding: 12px 30px;
                margin: 5px;
              "
            >
              ğŸ“¤ Share via Messenger
            </button>
          </div>

          <div
            style="
              margin-top: 20px;
              padding: 15px;
              background: white;
              border-radius: 8px;
              border: 1px solid #ddd;
            "
          >
            <strong>ğŸ“± Or share this link:</strong><br />
            <input
              type="text"
              id="codeShareLink"
              readonly
              style="margin-top: 10px; font-size: 12px"
            />
            <button
              onclick="copyCodeShareLink()"
              style="width: auto; padding: 8px 20px; margin-top: 10px"
            >
              ğŸ“‹ Copy Link
            </button>
          </div>
        </div>

        <button onclick="createAnotherPin()" style="background: #667eea">
          ğŸ“ Create Another Pin
        </button>
      </div>

      <!-- User Dashboard (Hidden, shows after login) -->
      <div id="userDashboard" style="display: none; min-height: 100px; width: 100%;">
        <div
          class="card"
          style="
            background: #f8f9fa;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <strong id="userName">User</strong>
            <span
              style="
                margin-left: 10px;
                background: #007bff;
                color: white;
                padding: 3px 10px;
                border-radius: 3px;
                font-size: 12px;
              "
              >ğŸ‘¤ USER</span
            >
          </div>
          <button
            onclick="userLogout()"
            style="width: auto; padding: 5px 15px; margin: 0; font-size: 13px"
          >
            Logout
          </button>
        </div>

        <!-- Welcome Message -->
        <div class="card" style="text-align: center; padding: 40px 20px;">
          <h2>Welcome back, <span id="userNameDisplay">User</span>! ğŸ‘‹</h2>
          <p style="font-size: 18px; color: #666; margin: 20px 0;">
            You're logged in and ready to go!
          </p>
        </div>

        <!-- Bulk Purchase Option -->
        <div class="card">
          <h3>ğŸ« Buy Bulk Access Codes</h3>
          <p style="color: #666; margin-bottom: 15px">
            Purchase access codes in bulk at wholesale prices and resell them for profit!
          </p>
          
          <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
            <strong>ğŸ’° Wholesale Pricing:</strong><br>
            <p style="margin: 10px 0;">
              â€¢ 10+ codes: 50% off retail price
            </p>
          </div>

          <a href="/bulk-purchase.html" style="text-decoration: none;">
            <button style="background: #28a745 !important; font-size: 16px; width: 100%;">
              ğŸ›’ Purchase Bulk Codes
            </button>
          </a>
        </div>

        <!-- Or Create Single Pin -->
        <div class="card">
          <h3>ğŸ“ Create a Single Pin</h3>
          <p style="color: #666; margin-bottom: 15px">
            Need just one pin? Create it now for â‚±150.
          </p>

          <button
            onclick="startPinCreation()"
            style="background: #007bff !important; font-size: 16px; width: 100%;"
          >
            Create Single Pin (â‚±150)
          </button>
        </div>
      </div>

      <!-- User Login Modal (Hidden by default) -->
      <div class="modal" id="loginModal" style="display: none">
        <div
          class="modal-content card"
          style="max-width: 500px; margin: 50px auto"
        >
          <button
            onclick="closeLogin()"
            style="
              position: absolute;
              top: 10px;
              right: 10px;
              width: auto;
              padding: 5px 15px;
            "
          >
            âœ•
          </button>

          <h3>ğŸ” User Login</h3>
          <p style="margin-bottom: 20px;">Login or create an account to access bulk purchasing and more!</p>

          <!-- Tab buttons -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee;">
            <button 
              id="loginTab" 
              onclick="showLoginForm()" 
              style="flex: 1; background: #007bff; border-bottom: 3px solid #007bff; margin-top: 0;"
            >
              Login
            </button>
            <button 
              id="signupTab" 
              onclick="showSignupForm()" 
              style="flex: 1; background: white; color: #333; border: none; border-bottom: 3px solid transparent; margin-top: 0;"
            >
              Sign Up
            </button>
          </div>

          <!-- Login Form -->
          <div id="loginForm">
          <div class="form-group">
            <label>Email:</label>
            <input type="text" id="loginEmail" placeholder="your@email.com" />
          </div>

          <div class="form-group">
            <label>Password:</label>
            <input
              type="password"
              id="loginPassword"
              placeholder="Enter password"
            />
          </div>

          <button onclick="userLogin()">Login</button>
          <div id="loginAuthStatus"></div>
          </div>

          <!-- Signup Form -->
          <div id="signupForm" style="display: none;">
          <div class="form-group">
            <label>Name:</label>
            <input type="text" id="signupName" placeholder="Your full name" />
          </div>

          <div class="form-group">
            <label>Email:</label>
            <input type="email" id="signupEmail" placeholder="your@email.com" />
          </div>

          <div class="form-group">
            <label>Phone:</label>
            <input type="tel" id="signupPhone" placeholder="+60123456789 or 09171234567" />
          </div>

          <div class="form-group">
            <label>Password:</label>
            <input type="password" id="signupPassword" placeholder="Minimum 6 characters" />
          </div>

          <button onclick="userSignup()">Create Account</button>
          <div id="signupAuthStatus"></div>
          </div>

          <div
            style="
              margin-top: 20px;
              padding: 15px;
              background: #e8f4fd;
              border-radius: 8px;
            "
          >
            <strong>ğŸ’¡ Why create an account?</strong><br />
            <p style="margin: 10px 0">
              â€¢ Buy access codes in bulk | 10 or more at 50% off<br>
              â€¢ Be able to create a location GPS QRCode with each access code used as payment<br>
              â€¢ Use access codes for payment when creating location GPS QRCodes for your customers at your price. Earn a profit.
            </p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div
        style="
          text-align: center;
          color: white;
          margin-top: 30px;
          padding: 20px;
        "
      >
        <p>
          <strong>dropLogik</strong> - Making deliveries easier across Southeast
          Asia and the World ğŸŒ
        </p>
        <p style="font-size: 13px; margin-top: 10px">
          Questions? Contact us: info@droplogik.com
        </p>
        <p style="font-size: 12px; margin-top: 15px; opacity: 0.8">
          <a
            href="/privacy-policy.html"
            style="color: white; text-decoration: underline; margin: 0 10px"
            >Privacy Policy</a
          >
          |
          <a
            href="/terms-of-service.html"
            style="color: white; text-decoration: underline; margin: 0 10px"
            >Terms of Service</a
          >
          |
          <a
            href="/disclaimer.html"
            style="color: white; text-decoration: underline; margin: 0 10px"
            >Disclaimer</a
          >
        </p>
        <p style="font-size: 11px; margin-top: 20px; opacity: 0.7">
          Â© 2025 dropLogik LLC. All rights reserved.
        </p>
      </div>
    </div>

    <!-- Application JavaScript -->
    <script src="/js/utils.js?v=2"></script>
    <script src="/js/map.js?v=2"></script>
    <script src="/js/payment-per-pin.js?v=2"></script>
    <script src="/js/user.js?v=2"></script>
    <script>
      // Clear any auto-filled values from form fields
      function clearAutoFilledFields() {
        // Clear Step 1 fields that shouldn't have auto-fill
        const locationName = document.getElementById('locationName');
        const mapAddress = document.getElementById('mapAddress');
        
        if (locationName && locationName.value) {
          console.log('Clearing auto-filled locationName');
          locationName.value = '';
        }
        
        if (mapAddress && mapAddress.value) {
          console.log('Clearing auto-filled mapAddress');
          mapAddress.value = '';
        }
      }

      // Auto-initialize map and detect currency when page loads
      window.addEventListener("DOMContentLoaded", async function () {
        await detectUserCurrency();
        
        // Initialize home page currency selector
        initializeHomeCurrency();
        
        // Clear any auto-filled values after a short delay (browsers auto-fill after load)
        setTimeout(clearAutoFilledFields, 100);
        
        // Initialize map immediately (falls back to IP-based location if GPS unavailable)
        initializeMap();

        // Update auth link based on login state
        const savedToken = localStorage.getItem('userToken');
        if (savedToken) {
          console.log('User logged in, waiting for checkUserSession');
          updateAuthLink(true);
        } else {
          updateAuthLink(false);
        }
      });

      // Toggle auth - show login modal or logout
      function toggleAuth() {
        const savedToken = localStorage.getItem('userToken');
        if (savedToken) {
          // User is logged in, so logout
          if (confirm('Are you sure you want to logout?')) {
            userLogout();
            updateAuthLink(false);
          }
        } else {
          // User not logged in, show login modal
          showLogin();
        }
      }

      // Update the auth link text based on login status
      function updateAuthLink(isLoggedIn) {
        const authLink = document.getElementById('authLink');
        if (authLink) {
          if (isLoggedIn) {
            authLink.textContent = 'Logout';
          } else {
            authLink.textContent = 'Resellers Login / Sign Up';
          }
        }
      }

      // Enable/disable pay button based on TOS checkbox
      function updatePayButtonState() {
        const checkbox = document.getElementById("tosCheckbox");
        const payButton = document.getElementById("payButton");

        if (checkbox && payButton) {
          if (checkbox.checked) {
            payButton.disabled = false;
            payButton.style.opacity = "1";
            payButton.style.cursor = "pointer";
          } else {
            payButton.disabled = true;
            payButton.style.opacity = "0.5";
            payButton.style.cursor = "not-allowed";
          }
        }
      }

      // Update currency throughout the home page when user selects
      function updateHomeCurrency() {
        const currencyCode = document.getElementById("homeCurrencySelect")?.value || 'PHP';
        const currencyInfo = getCurrencyInfo(currencyCode);
        
        // Update all dynamic-price elements (How It Works section, buttons)
        const priceElements = document.querySelectorAll('.dynamic-price');
        priceElements.forEach(el => {
          el.textContent = `${currencyInfo.symbol}${currencyInfo.price.toLocaleString()}`;
        });
        
        // Update payment amount in Step 2 button
        const paymentAmount = document.getElementById('paymentAmount');
        if (paymentAmount) {
          paymentAmount.textContent = `${currencyInfo.symbol}${currencyInfo.price.toLocaleString()}`;
        }
        
        // Update currency select in payment section (Step 2) if it exists
        const currencySelect = document.getElementById('currencySelect');
        if (currencySelect) {
          currencySelect.value = currencyCode;
        }
        
        // Save preference
        saveCurrencyPreference(currencyCode);
        
        console.log(`ğŸ’° Home currency updated to: ${currencyCode}`);
      }

      // Initialize home page currency on load
      function initializeHomeCurrency() {
        const saved = getSavedCurrency();
        const detected = saved || detectCurrencyFromLocale();
        
        const homeCurrencySelect = document.getElementById('homeCurrencySelect');
        if (homeCurrencySelect) {
          homeCurrencySelect.value = detected;
          updateHomeCurrency();
          console.log(`ğŸ’° Home currency initialized: ${detected} ${saved ? '(saved preference)' : '(auto-detected)'}`);
        }
      }

      // Show payment mode
      function showPaymentMode() {
        document.getElementById('paymentMode').style.display = 'block';
        document.getElementById('codeModeCard').style.display = 'none';
        document.getElementById('paymentModeBtn').style.background = '#007bff';
        document.getElementById('paymentModeBtn').style.color = 'white';
        document.getElementById('codeModeBtn').style.background = 'white';
        document.getElementById('codeModeBtn').style.color = '#28a745';
      }

      // Show code mode
      function showCodeMode() {
        document.getElementById('paymentMode').style.display = 'none';
        document.getElementById('codeModeCard').style.display = 'block';
        document.getElementById('codeModeBtn').style.background = '#28a745';
        document.getElementById('codeModeBtn').style.color = 'white';
        document.getElementById('paymentModeBtn').style.background = 'white';
        document.getElementById('paymentModeBtn').style.color = '#007bff';
      }

      // Create pin with access code
      async function createPinWithCode() {
        const accessCode = document.getElementById('accessCode').value.trim();
        const customerPhone = document.getElementById('codeCustomerPhone').value.trim();

        if (!accessCode) {
          alert('Please enter your access code');
          return;
        }

        if (!customerPhone) {
          alert('Please enter your mobile number');
          return;
        }

        if (!correctedPosition) {
          alert('Please set your location on the map first');
          return;
        }

        const locationName = document.getElementById('locationName').value.trim();
        const address = document.getElementById('mapAddress').value.trim();

        if (!locationName) {
          alert('Please enter a location name');
          return;
        }

        try {
          showStatus('Validating access code...', 'info');

          const response = await fetch('/api/pin/create-with-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              accessCode: accessCode,
              locationName: locationName,
              customerPhone: customerPhone,
              address: address,
              latitude: originalPosition.lat,
              longitude: originalPosition.lng,
              correctedLatitude: correctedPosition.lat,
              correctedLongitude: correctedPosition.lng
            })
          });

          const data = await response.json();

          if (!data.success) {
            showStatus(data.error || 'Failed to create pin with code', 'error');
            return;
          }

          // Show QR code
          displayCodeQRCode(data.pin);
          hideStatusMessage();

        } catch (error) {
          console.error('Code redemption error:', error);
          showStatus('Error creating pin. Please try again.', 'error');
        }
      }

      function hideStatusMessage() {
        const statusElement = document.getElementById("statusMessage");
        if (statusElement) {
          statusElement.style.display = "none";
        }
      }

      function displayCodeQRCode(pin) {
        const codeSection = document.getElementById('codeQrSection');
        const details = document.getElementById('codeQrDetails');
        const canvas = document.getElementById('codeQrCanvas');
        const shareLink = document.getElementById('codeShareLink');

        if (!codeSection || !details || !canvas || !shareLink) {
          console.error('Missing access-code QR elements');
          alert('Error displaying QR code. Please contact support.');
          return;
        }

        const lat = Number(pin?.correctedLatitude ?? pin?.latitude);
        const lng = Number(pin?.correctedLongitude ?? pin?.longitude);
        const coordsText = !isNaN(lat) && !isNaN(lng)
          ? `${lat.toFixed(6)}, ${lng.toFixed(6)}`
          : 'Coordinates unavailable';

        details.innerHTML = `
          <h4>${pin?.locationName || 'Location'}</h4>
          <p style="color: #666; margin: 5px 0;">${pin?.address || 'No address specified'}</p>
          <p style="font-size: 13px; color: #999;">
            Pin ID: ${pin?.pinId || 'N/A'}<br>
            <strong>ğŸ“ GPS Coordinates:</strong> ${coordsText}
          </p>
        `;

        canvas.innerHTML = '';
        if (!isNaN(lat) && !isNaN(lng)) {
          const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
          if (typeof renderQRCode === 'function') {
            renderQRCode(canvas, mapUrl);
          } else {
            new QRCode(canvas, {
              text: mapUrl,
              width: 200,
              height: 200,
              colorDark: "#0000ff",
              colorLight: "#FFFFFF",
              correctLevel: QRCode.CorrectLevel.H
            });
          }
          shareLink.value = mapUrl;
        } else {
          shareLink.value = '';
        }

        // Hide other cards and show access-code QR section
        const allCards = document.querySelectorAll('#mainPinSection .card');
        allCards.forEach(card => {
          if (card.id !== 'codeQrSection') {
            card.style.display = 'none';
          }
        });
        codeSection.style.display = 'block';
        codeSection.scrollIntoView({ behavior: 'smooth' });
      }

      function copyCodeShareLink() {
        const shareLink = document.getElementById('codeShareLink');
        if (shareLink) {
          shareLink.select();
          document.execCommand('copy');
          showStatus('Link copied to clipboard!', 'success');
        }
      }

      // Display QR code (reuse existing function or create if not exists)
      function displayQRCode(pin) {
        const qrSection = document.getElementById('qrSection');
        const qrDetails = document.getElementById('qrDetails');
        const shareLink = document.getElementById('shareLink');
        const mainSection = document.getElementById('mainPinSection');
        const dashboardSection = document.getElementById('userDashboard');

        if (!qrSection || !qrDetails || !shareLink) {
          console.error('Missing QR elements');
          alert('Error displaying QR code. Please contact support.');
          return;
        }

        // Ensure QR container and its parents are visible
        if (mainSection) {
          mainSection.style.display = 'block';
        }
        if (dashboardSection) {
          dashboardSection.style.display = 'none';
        }
        let parent = qrSection;
        while (parent && parent !== document.body) {
          const display = window.getComputedStyle(parent).display;
          if (display === 'none') {
            parent.style.display = 'block';
          }
          parent = parent.parentElement;
        }

        const resolvedPin = pin && pin.pin ? pin.pin : pin;
        const lat = Number(resolvedPin?.correctedLatitude ?? resolvedPin?.latitude);
        const lng = Number(resolvedPin?.correctedLongitude ?? resolvedPin?.longitude);

        // Set details
        const coordsText = !isNaN(lat) && !isNaN(lng)
          ? `${lat.toFixed(6)}, ${lng.toFixed(6)}`
          : 'Coordinates unavailable';

        qrDetails.innerHTML = `
          <h4>${resolvedPin?.locationName || 'Location'}</h4>
          <p style="color: #666; margin: 5px 0;">${resolvedPin?.address || 'No address specified'}</p>
          <p style="font-size: 13px; color: #999;">
            Pin ID: ${resolvedPin?.pinId || 'N/A'}<br>
            <strong>ğŸ“ GPS Coordinates:</strong> ${coordsText}
          </p>
        `;

        // Generate QR code with link to location
        if (!isNaN(lat) && !isNaN(lng)) {
          const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
          generateQRCode(mapUrl);
          shareLink.value = mapUrl;
        } else {
          qrSection.style.display = 'block';
          shareLink.value = '';
          return;
        }

        // Show QR section
        qrSection.style.display = 'block';

        // Hide other cards
        const allCards = document.querySelectorAll('#mainPinSection .card');
        allCards.forEach(card => {
          if (card.id !== 'qrSection') {
            card.style.display = 'none';
          }
        });

        // Scroll to QR section
        qrSection.scrollIntoView({ behavior: 'smooth' });
      }
    </script>
  </body>
</html>
