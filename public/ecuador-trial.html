<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ecuador Postal Service - dropLogik Trial</title>

    <!-- External CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link rel="stylesheet" href="/css/styles.css" />

    <!-- External JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
      /* Ecuador-themed colors */
      :root {
        --ecuador-yellow: #FFD100;
        --ecuador-blue: #0039A6;
        --ecuador-red: #ED1C24;
      }
      
      .header {
        background: linear-gradient(135deg, var(--ecuador-yellow) 0%, var(--ecuador-blue) 100%) !important;
      }
      
      .btn-primary {
        background: var(--ecuador-blue) !important;
      }
      
      .btn-primary:hover {
        background: var(--ecuador-red) !important;
      }
      
      .trial-banner {
        background: var(--ecuador-yellow);
        color: var(--ecuador-blue);
        padding: 20px;
        text-align: center;
        font-weight: bold;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .trial-code-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid var(--ecuador-blue);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <div class="header" style="position: relative;">
        <img src="/pics/ecuador-flag.png" alt="Ecuador Flag" style="position: absolute; top: 10px; left: 10px; width: 60px; height: auto; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">
        <a href="/" style="display: inline-block;">
          <img src="/pics/dropLogik-logo2.png" alt="dropLogik Logo" style="max-width: 188px; height: auto; padding-top: 15px; margin: 0 auto 10px; display: block; background: transparent;">
        </a>
        <h2 style="margin: 10px 0;">Ecuador Postal Service Trial</h2>
        <p>
          Digital Addressing for Reliable Delivery -- Create scannable locations for areas without formal addresses.
        </p>
      </div>

      <!-- Trial Banner -->
      <div class="trial-banner">
        üá™üá® Exclusive Trial for Ecuador Postal Service üá™üá®
      </div>

      <!-- Trial Code Entry Section -->
      <div id="trialCodeSection" class="trial-code-section">
        <h3 style="margin-top: 0;">Enter Your Trial Access Code</h3>
        <p style="color: #666; font-size: 14px;">Please enter the access code provided to you by dropLogik</p>
        
        <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
          <input 
            type="text" 
            id="trialCodeInput" 
            placeholder="ECUADOR-TRIAL-XXXX"
            style="flex: 1; min-width: 250px; padding: 12px; border-radius: 6px; border: 1px solid #ddd; font-size: 16px; text-transform: uppercase; width: 100%; box-sizing: border-box;"
          />
          <button 
            onclick="validateTrialCode()" 
            class="btn-primary"
            style="padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: bold; white-space: nowrap;"
          >
            Validate Code
          </button>
        </div>
        
        <div id="trialCodeMessage" style="margin-top: 15px;"></div>
      </div>

      <!-- Main Pin Creation Section (Hidden until code validated) -->
      <div id="mainPinSection" style="display: none;">
        
        <!-- Trial Info -->
        <div class="card" style="background: #e7f3ff; padding: 15px; margin-bottom: 20px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 24px;">‚úÖ</span>
            <div>
              <strong>Trial Code Active</strong>
              <div id="trialInfo" style="font-size: 13px; color: #666; margin-top: 5px;"></div>
            </div>
          </div>
        </div>

        <!-- Step 1: Location Details -->
        <div class="card">
          <h2>Step 1: Enter Location Details</h2>
          <form id="locationForm">
            <input
              type="text"
              id="locationName"
              placeholder="Location Name (e.g., Maria's House)"
              required
              style="margin-bottom: 15px;"
            />
            <input
              type="tel"
              id="customerPhone"
              placeholder="Phone Number"
              required
              style="margin-bottom: 15px;"
            />
            <textarea
              id="address"
              placeholder="Address or Landmark (Optional)"
              rows="2"
            ></textarea>
          </form>
        </div>

        <!-- Step 2: GPS Coordinates -->
        <div class="card">
          <h2>Step 2: Set Your Location</h2>
          <p id="locationStatus" style="margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px;">
            üìç Map will load automatically. Drag the green marker to your exact location.
          </p>
        </div>

        <!-- Map Preview -->
        <div class="card">
          <h2>Location Preview</h2>
          <div id="map"></div>
        </div>

        <!-- Drone Delivery Section (Optional) -->
        <div class="card">
          <div style="margin-bottom: 15px">
            <label style="display: flex; align-items: center; cursor: pointer">
              <input
                type="checkbox"
                id="droneEnabled"
                style="margin-right: 8px; width: 18px; height: 18px; cursor: pointer"
                onchange="toggleDroneFields()"
              />
              <span>üöÅ Enable Drone Delivery Data (Optional)</span>
            </label>
            <small style="color: #666; display: block; margin-top: 5px">
              Prepare this location for future autonomous postal deliveries
            </small>
          </div>

          <!-- Drone Delivery Fields (hidden by default) -->
          <div id="droneFields" style="display: none; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6">
            <h4 style="margin-top: 0; color: var(--ecuador-blue); font-size: 16px">üöÅ Drone Delivery Details</h4>
            
            <div style="margin-bottom: 15px;">
              <label>Landing Zone Type:</label>
              <select id="landingZoneType" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd">
                <option value="">-- Select --</option>
                <option value="roof">Roof</option>
                <option value="yard">Yard/Garden</option>
                <option value="balcony">Balcony</option>
                <option value="street">Street Level</option>
                <option value="field">Open Field</option>
                <option value="other">Other</option>
              </select>
            </div>

            <div style="margin-bottom: 15px;">
              <label>Drop Zone Size (meters):</label>
              <div style="display: flex; gap: 10px">
                <input
                  type="number"
                  id="dropZoneWidth"
                  placeholder="Width (m)"
                  min="1"
                  step="0.5"
                  style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd"
                />
                <input
                  type="number"
                  id="dropZoneLength"
                  placeholder="Length (m)"
                  min="1"
                  step="0.5"
                  style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd"
                />
              </div>
              <small style="color: #666">Minimum safe landing area dimensions</small>
            </div>

            <div style="margin-bottom: 15px;">
              <label>Height Above Ground:</label>
              <div style="display: flex; gap: 10px">
                <input
                  type="text"
                  id="floorNumber"
                  placeholder="e.g., 3rd floor, rooftop"
                  style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd"
                />
                <input
                  type="number"
                  id="heightAboveGround"
                  placeholder="Height (m)"
                  min="0"
                  step="0.5"
                  style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd"
                />
              </div>
              <small style="color: #666">Floor description and approximate height in meters</small>
            </div>

            <div style="margin-bottom: 15px;">
              <label>Nearby Obstacles (optional):</label>
              <textarea
                id="droneObstacles"
                placeholder="e.g., trees on west side, power lines 5m north, tall building to east"
                rows="2"
                style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; resize: vertical"
              ></textarea>
            </div>

            <div style="margin-bottom: 15px;">
              <label>Access Restrictions (optional):</label>
              <input
                type="text"
                id="accessRestrictions"
                placeholder="e.g., private property - permission granted, gated community"
                style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd"
              />
            </div>

            <div style="margin-bottom: 15px;">
              <label>Preferred Approach Direction (optional):</label>
              <input
                type="text"
                id="approachDirection"
                placeholder="e.g., from south, avoid west side due to trees"
                style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd"
              />
            </div>

            <div style="margin-bottom: 0;">
              <label>Additional Notes (optional):</label>
              <textarea
                id="droneNotes"
                placeholder="Any other information useful for drone delivery operators"
                rows="2"
                style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; resize: vertical"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Step 3: Create Pin -->
        <div class="card">
          <h2>Step 3: Create Your Pin</h2>
          <button
            id="createPinBtn"
            class="btn-primary"
            onclick="createPin()"
            disabled
          >
            Create Pin (Trial Access)
          </button>
        </div>

        <!-- Result Section -->
        <div id="resultSection" class="card" style="display: none">
          <h2>Your Location Pin</h2>
          <div id="pinResult"></div>
          <div id="qrCodeContainer"></div>
          <div class="button-group">
            <button class="btn-secondary" onclick="downloadQR()">
              Download QR Code
            </button>
            <button class="btn-secondary" onclick="sharePin()">
              Share Pin
            </button>
          </div>
          <button class="btn-secondary" onclick="resetForm()">
            Create Another Pin
          </button>
        </div>
      </div>

      <!-- Footer -->
      <div style="
        text-align: center;
        color: white;
        margin-top: 30px;
        padding: 20px;
      ">
        <p style="font-size: 11px; margin-bottom: 10px; font-style: italic;">
          Pilot access provided for evaluation purposes. No transfer of intellectual property or implementation rights.
        </p>
        <p>&copy; 2026 dropLogik. All rights reserved.</p>
        <p>
          <a href="/privacy-policy.html?from=trial" style="color: white; margin: 0 10px">Privacy Policy</a> |
          <a href="/terms-of-service.html?from=trial" style="color: white; margin: 0 10px">Terms of Service</a> |
          <a href="/disclaimer.html?from=trial" style="color: white; margin: 0 10px">Disclaimer</a>
        </p>
      </div>
    </div>

    <!-- Internal JavaScript -->
    <script src="/js/utils.js"></script>
    <script src="/js/location.js"></script>
    <script src="/js/map.js"></script>
    <script>
      // Trial-specific variables
      let validatedTrialCode = null;
      let trialConfig = null;

      // Load trial configuration
      async function loadTrialConfig() {
        try {
          const response = await fetch('/trial/api/ecuador-trial/config');
          if (response.ok) {
            trialConfig = await response.json();
          }
        } catch (error) {
          console.error('Error loading trial config:', error);
        }
      }

      // Validate trial code
      async function validateTrialCode() {
        const codeInput = document.getElementById('trialCodeInput');
        const code = codeInput.value.trim();
        const messageDiv = document.getElementById('trialCodeMessage');

        if (!code) {
          messageDiv.innerHTML = '<p style="color: #ED1C24;">Please enter a trial code</p>';
          return;
        }

        try {
          const response = await fetch('/trial/api/validate-code', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ code })
          });

          const data = await response.json();

          if (data.success) {
            validatedTrialCode = code.toUpperCase();
            messageDiv.innerHTML = `<p style="color: #28a745;">‚úÖ Code validated successfully!</p>`;
            
            // Show trial info
            let infoText = `Trial: ${data.trialName}`;
            if (data.remainingUses) {
              infoText += ` | Remaining uses: ${data.remainingUses}`;
            }
            if (data.expiresAt) {
              const expDate = new Date(data.expiresAt).toLocaleDateString();
              infoText += ` | Expires: ${expDate}`;
            }
            document.getElementById('trialInfo').textContent = infoText;
            
            // Hide code section and show main section
            setTimeout(() => {
              document.getElementById('trialCodeSection').style.display = 'none';
              document.getElementById('mainPinSection').style.display = 'block';
              initializeMap();
            }, 1000);
          } else {
            messageDiv.innerHTML = `<p style="color: #ED1C24;">‚ùå ${data.error}</p>`;
          }
        } catch (error) {
          console.error('Error validating code:', error);
          messageDiv.innerHTML = '<p style="color: #ED1C24;">Error validating code. Please try again.</p>';
        }
      }

      // Toggle drone fields visibility
      function toggleDroneFields() {
        const droneEnabled = document.getElementById('droneEnabled').checked;
        const droneFields = document.getElementById('droneFields');
        droneFields.style.display = droneEnabled ? 'block' : 'none';
      }

      // Collect drone data from form
      function collectDroneData() {
        const droneEnabled = document.getElementById('droneEnabled').checked;
        
        if (!droneEnabled) {
          return { droneEnabled: false };
        }

        return {
          droneEnabled: true,
          droneLandingZoneType: document.getElementById('landingZoneType').value || null,
          droneDropZoneWidth: parseFloat(document.getElementById('dropZoneWidth').value) || null,
          droneDropZoneLength: parseFloat(document.getElementById('dropZoneLength').value) || null,
          droneFloor: document.getElementById('floorNumber').value || null,
          droneHeight: parseFloat(document.getElementById('heightAboveGround').value) || null,
          droneObstacles: document.getElementById('droneObstacles').value || null,
          droneAccessRestrictions: document.getElementById('accessRestrictions').value || null,
          droneApproachDirection: document.getElementById('approachDirection').value || null,
          droneNotes: document.getElementById('droneNotes').value || null
        };
      }

      // Override createPin function to use trial code
      async function createPin() {
        if (!validatedTrialCode) {
          alert('Please validate your trial code first');
          return;
        }

        const locationName = document.getElementById('locationName').value;
        const customerPhone = document.getElementById('customerPhone').value;
        const address = document.getElementById('address').value;

        if (!locationName || !customerPhone) {
          alert('Please fill in all required fields');
          return;
        }

        if (!window.currentLocation || !window.correctedLocation) {
          alert('Please get GPS location first');
          return;
        }

        try {
          // Collect drone data
          const droneData = collectDroneData();

          const response = await fetch('/api/pin/create-with-trial', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              locationName,
              customerPhone,
              address,
              latitude: window.currentLocation.lat,
              longitude: window.currentLocation.lng,
              correctedLatitude: window.correctedLocation.lat,
              correctedLongitude: window.correctedLocation.lng,
              correctionDistance: window.correctionDistance || 0,
              trialCode: validatedTrialCode,
              ...droneData
            }),
          });

          const data = await response.json();

          if (data.success) {
            displayPinResult(data.pin);
          } else {
            alert('Error creating pin: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error creating pin:', error);
          alert('Error creating pin. Please try again.');
        }
      }

      // Utility: Escape HTML to prevent XSS and rendering errors
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Display pin result
      function displayPinResult(pin) {
        const resultSection = document.getElementById('resultSection');
        const pinResult = document.getElementById('pinResult');

        let droneDetailsHtml = '';
        if (pin.droneEnabled && pin.droneData) {
          droneDetailsHtml = `
            <div style="background: #e8f4fd; padding: 10px; border-radius: 5px; margin-top: 10px;">
              <p style="margin: 0 0 8px 0;"><strong style="color: #007bff;">üöÅ Drone Delivery Details:</strong></p>
              ${pin.droneData.landingZoneType ? `<p><strong>Landing Zone:</strong> ${escapeHtml(pin.droneData.landingZoneType)}</p>` : ''}
              ${pin.droneData.dropZoneDimensions && (pin.droneData.dropZoneDimensions.width || pin.droneData.dropZoneDimensions.length) ? 
                `<p><strong>Drop Zone Size:</strong> ${pin.droneData.dropZoneDimensions.width || '?'}m √ó ${pin.droneData.dropZoneDimensions.length || '?'}m</p>` : ''}
              ${pin.droneData.floorNumber ? `<p><strong>Floor:</strong> ${escapeHtml(pin.droneData.floorNumber)}</p>` : ''}
              ${pin.droneData.heightAboveGround ? `<p><strong>Height:</strong> ${pin.droneData.heightAboveGround}m above ground</p>` : ''}
              ${pin.droneData.obstacles ? `<p><strong>Obstacles:</strong> ${escapeHtml(pin.droneData.obstacles)}</p>` : ''}
              ${pin.droneData.accessRestrictions ? `<p><strong>Access:</strong> ${escapeHtml(pin.droneData.accessRestrictions)}</p>` : ''}
              ${pin.droneData.approachDirection ? `<p><strong>Approach:</strong> ${escapeHtml(pin.droneData.approachDirection)}</p>` : ''}
              ${pin.droneData.notes ? `<p><strong>Notes:</strong> ${escapeHtml(pin.droneData.notes)}</p>` : ''}
            </div>
          `;
        }

        pinResult.innerHTML = `
          <div class="pin-details">
            <p><strong>Pin ID:</strong> ${pin.pinId}</p>
            <p><strong>Location:</strong> ${escapeHtml(pin.locationName)}</p>
            <p><strong>Phone:</strong> ${escapeHtml(pin.customerPhone)}</p>
            <p><strong>Coordinates:</strong> ${pin.correctedLatitude.toFixed(6)}, ${pin.correctedLongitude.toFixed(6)}</p>
            ${pin.address ? `<p><strong>Address:</strong> ${escapeHtml(pin.address)}</p>` : ''}
          </div>
          ${droneDetailsHtml}
        `;

        // Generate QR Code
        const qrContainer = document.getElementById('qrCodeContainer');
        qrContainer.innerHTML = '<div id="qrcode" style="position: relative; width: 256px; height: 256px;"></div>';
        
        // Use stored Google Maps URL from database
        const qrText = pin.googleMapsUrl || `https://www.google.com/maps/dir/?api=1&destination=${pin.correctedLatitude},${pin.correctedLongitude}`;
        
        new QRCode(document.getElementById('qrcode'), {
          text: qrText,
          width: 256,
          height: 256,
          colorDark: '#0066ff',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
        
        // Add logo overlay
        setTimeout(() => {
            const qrDiv = document.getElementById('qrcode');
            const logoSize = 51; // 20% of 256px
            const bgSize = logoSize + 6;
            
            // Create circular white background
            const bgCircle = document.createElement('div');
            bgCircle.style.position = 'absolute';
            bgCircle.style.left = '50%';
            bgCircle.style.top = '50%';
            bgCircle.style.transform = 'translate(-50%, -50%)';
            bgCircle.style.width = `${bgSize}px`;
            bgCircle.style.height = `${bgSize}px`;
            bgCircle.style.backgroundColor = '#ffffff';
            bgCircle.style.borderRadius = '50%';
            bgCircle.style.pointerEvents = 'none';
            qrDiv.appendChild(bgCircle);
            
            // Create logo on top
            const logo = document.createElement('img');
            logo.src = '/pics/for_qrcode.png';
            logo.alt = 'dropLogik';
            logo.style.position = 'absolute';
            logo.style.left = '50%';
            logo.style.top = '50%';
            logo.style.transform = 'translate(-50%, -50%)';
            logo.style.width = `${logoSize}px`;
            logo.style.height = `${logoSize}px`;
            logo.style.objectFit = 'contain';
            logo.style.pointerEvents = 'none';
            qrDiv.appendChild(logo);
        }, 100);

        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth' });
      }

      // Download QR code
      function downloadQR() {
        const qrElement = document.getElementById('qrcode');
        html2canvas(qrElement).then(canvas => {
          const link = document.createElement('a');
          link.download = 'location-pin-qr.png';
          link.href = canvas.toDataURL();
          link.click();
        });
      }

      // Share pin
      function sharePin() {
        const pinId = document.querySelector('.pin-details p:first-child').textContent.split(': ')[1];
        const shareText = `My location pin: ${window.location.origin}/pin/${pinId}`;
        
        if (navigator.share) {
          navigator.share({
            title: 'My Location Pin',
            text: shareText
          });
        } else {
          navigator.clipboard.writeText(shareText);
          alert('Link copied to clipboard!');
        }
      }

      // Reset form
      function resetForm() {
        document.getElementById('locationForm').reset();
        document.getElementById('resultSection').style.display = 'none';
        document.getElementById('coordinatesDisplay').style.display = 'none';
        document.getElementById('createPinBtn').disabled = true;
        window.currentLocation = null;
        window.correctedLocation = null;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Track location state and enable create pin button
      function updateLocationState(rawLat, rawLng, correctedLat, correctedLng) {
        window.currentLocation = { lat: rawLat, lng: rawLng };
        window.correctedLocation = { lat: correctedLat, lng: correctedLng };
        
        // Calculate correction distance
        const R = 6371e3; // Earth radius in meters
        const œÜ1 = rawLat * Math.PI / 180;
        const œÜ2 = correctedLat * Math.PI / 180;
        const ŒîœÜ = (correctedLat - rawLat) * Math.PI / 180;
        const ŒîŒª = (correctedLng - rawLng) * Math.PI / 180;
        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        window.correctionDistance = R * c;
        
        // Enable create pin button
        const createBtn = document.getElementById('createPinBtn');
        if (createBtn) {
          createBtn.disabled = false;
          document.getElementById('locationStatus').innerHTML = 
            '<strong style="color: #28a745;">‚úÖ Location set! You can now create your pin.</strong>';
        }
      }

      // Override map.js setupMap to track location
      const originalSetupMap = window.setupMap;
      window.setupMap = function(lat, lng, useGPS) {
        // Call original setupMap if it exists
        if (typeof originalSetupMap === 'function') {
          originalSetupMap(lat, lng, useGPS);
        }
        
        // Track initial location
        updateLocationState(lat, lng, lat, lng);
      };

      // Initialize on load
      loadTrialConfig();
    </script>
  </body>
</html>
