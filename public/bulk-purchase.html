<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Purchase - dropLogik</title>
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#0000ff">
    <link rel="apple-touch-icon" href="/pics/pwa/icon-192.png">
    <link rel="icon" href="/pics/pwa/icon-512.png" sizes="512x512" type="image/png">
    <link rel="icon" href="/pics/pwa/icon-192.png" sizes="192x192" type="image/png">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/utils.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="text-align: left; margin-bottom: 20px;">
              <a href="/" style="display: inline-block;">
                <img src="/pics/dropLogik-logo.png" alt="dropLogik Logo" style="width: 180px; height: auto; background: transparent;">
              </a>
            </div>
            <h1>ğŸ“¦ Bulk Purchase Access Codes</h1>
            <p>Buy in bulk and resell for profit!</p>
        </div>

        <div class="card" style="background: #e8f4fd; border-left: 4px solid #007bff;">
            <h3>ğŸ’° Wholesale Pricing</h3>
            <div style="margin: 15px 0;">
                <p style="font-size: 18px; margin: 10px 0;">
                    <strong>10+ codes:</strong> <span id="bulkPrice">â‚±75</span> per code 
                    <span style="color: #28a745;">(50% discount)</span>
                </p>
            </div>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">
                Retail price: <span id="retailPrice">â‚±150</span> per pin - Resell and keep the profit!
            </p>
        </div>

        <div class="card">
            <h3>ğŸ¯ How It Works</h3>
            <ol style="line-height: 2; color: #333;">
                <li><strong>Buy codes in bulk</strong> - Get instant discount</li>
                <li><strong>Receive access codes</strong> - Download or copy all codes</li>
                <li><strong>Resell to customers</strong> - Help customers through the mapping and GPS QRCode creation process, 
                    using your access code for payment. Get payment at your price from customers</li>
                <li><strong>Keep your profit</strong> - No commission split with us!</li>
            </ol>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px;">
                <strong>ğŸ“Š Example Profit:</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>Buy 10 codes at <span id="exampleBuyPrice">â‚±75</span> each = <span id="exampleBuyCost">â‚±750</span></li>
                    <li>Sell 10 codes at <span id="exampleSellPrice">â‚±150</span> each = <span id="exampleSellRevenue">â‚±1500</span></li>
                    <li><strong style="color: #28a745;">Your profit = <span id="exampleProfit">â‚±750</span></strong></li>
                </ul>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ Purchase Form</h3>
            
            <div class="form-group">
                <label>Currency:</label>
                <select id="currencySelect" onchange="updateBulkPrice()" style="padding: 10px; border-radius: 6px; border: 1px solid #ddd; width: 100%; font-size: 16px;">
                    <option value="PHP">ğŸ‡µğŸ‡­ Philippine Peso (â‚±)</option>
                    <option value="MYR">ğŸ‡²ğŸ‡¾ Malaysian Ringgit (RM)</option>
                    <option value="SGD">ğŸ‡¸ğŸ‡¬ Singapore Dollar (S$)</option>
                    <option value="THB">ğŸ‡¹ğŸ‡­ Thai Baht (à¸¿)</option>
                    <option value="IDR">ğŸ‡®ğŸ‡© Indonesian Rupiah (Rp)</option>
                    <option value="VND">ğŸ‡»ğŸ‡³ Vietnamese Dong (â‚«)</option>
                    <option value="HKD">ğŸ‡­ğŸ‡° Hong Kong Dollar (HK$)</option>
                    <option value="USD">ğŸŒ US Dollar ($)</option>
                    <option value="MXN">ğŸ‡²ğŸ‡½ Mexican Peso (MX$)</option>
                    <option value="BRL">ğŸ‡§ğŸ‡· Brazilian Real (R$)</option>
                    <option value="COP">ğŸ‡¨ğŸ‡´ Colombian Peso (COL$)</option>
                    <option value="ARS">ğŸ‡¦ğŸ‡· Argentine Peso (ARS$)</option>
                </select>
                <small style="color: #666;">Select your preferred payment currency</small>
            </div>

            <div class="form-group">
                <label>Quantity (minimum 10):</label>
                <input type="number" id="quantity" min="10" value="10" onchange="updateBulkPrice()">
                <small style="color: #666;">Enter how many codes you want to purchase</small>
            </div>

            <div class="form-group">
                <label>Your Email:</label>
                <input type="email" id="email" placeholder="your@email.com">
                <small style="color: #666;">We'll send the codes here too</small>
            </div>

            <div class="form-group">
                <label>Your Mobile Number:</label>
                <input type="tel" id="phone" placeholder="+60123456789 or 09171234567">
                <small style="color: #666;">For verification and support</small>
            </div>

            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                    <span>Quantity:</span>
                    <strong id="displayQuantity">10</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 10px 0;">
                    <span>Price per code:</span>
                    <strong id="displayUnitPrice">â‚±75</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 15px 0; padding-top: 15px; border-top: 2px solid #dee2e6; font-size: 20px;">
                    <span>Total:</span>
                    <strong id="displayTotal" style="color: #28a745;">â‚±750</strong>
                </div>
            </div>

            <button onclick="proceedToBulkPayment()" class="register-btn" style="background: #28a745 !important; font-size: 18px;">
                ğŸ’³ Proceed to Payment
            </button>

            <div style="text-align: center; margin-top: 20px;">
                <a href="/" style="color: #007bff; text-decoration: underline;">â† Back to create single pin</a>
            </div>
        </div>

        <div class="card" style="background: #f8f9fa;">
            <h3>â“ Frequently Asked Questions</h3>
            
            <details style="margin: 15px 0; cursor: pointer;">
                <summary style="font-weight: bold; padding: 10px; background: white; border-radius: 6px;">
                    How long are access codes valid?
                </summary>
                <p style="padding: 15px; color: #666;">
                    All access codes are valid for 180 days (6 months) from purchase. Use them or resell them within this period.
                </p>
            </details>

            <details style="margin: 15px 0; cursor: pointer;">
                <summary style="font-weight: bold; padding: 10px; background: white; border-radius: 6px;">
                    Can access codes be used multiple times?
                </summary>
                <p style="padding: 15px; color: #666;">
                    No. Each access code can only be used ONCE to create one GPS QRCode. After use, the access code becomes invalid.
                </p>
            </details>

            <details style="margin: 15px 0; cursor: pointer;">
                <summary style="font-weight: bold; padding: 10px; background: white; border-radius: 6px;">
                    What if my customer loses their access code?
                </summary>
                <p style="padding: 15px; color: #666;">
                    As the reseller, you should be helping the customer through the online mapping and GPS QRCode creation process but using your access codes during payment and receiving payment from them. If you lose access codes, that is a loss for your business.
                </p>
            </details>

            <details style="margin: 15px 0; cursor: pointer;">
                <summary style="font-weight: bold; padding: 10px; background: white; border-radius: 6px;">
                    Can I get a refund?
                </summary>
                <p style="padding: 15px; color: #666;">
                    What you buy is final and non-refundable; we just don't want the headache involved in refunds, etc.
                </p>
            </details>
        </div>
    </div>

    <script>
        function updateBulkPrice() {
            const quantity = parseInt(document.getElementById('quantity').value) || 10;
            const currencyCode = document.getElementById('currencySelect').value || 'PHP';
            const currencyInfo = getCurrencyInfo(currencyCode);
            
            // Ensure minimum quantity
            if (quantity < 10) {
                document.getElementById('quantity').value = 10;
                return;
            }

            // Calculate base unit price in selected currency
            const basePrice = currencyInfo.price; // Price per single pin
            
            // Apply 50% discount for 10+ codes
            const discountRate = 0.50; // 50% discount for all bulk purchases
            
            // For currencies with decimals (USD, SGD), preserve decimal precision
            // For whole number currencies (PHP, MYR, etc), round to integer
            const hasDecimals = basePrice < 10 || basePrice % 1 !== 0;
            const unitPrice = hasDecimals 
                ? parseFloat((basePrice * discountRate).toFixed(2))
                : Math.round(basePrice * discountRate);
            const total = hasDecimals 
                ? parseFloat((quantity * unitPrice).toFixed(2))
                : quantity * unitPrice;

            // Update display with selected currency
            document.getElementById('displayQuantity').textContent = quantity;
            document.getElementById('displayUnitPrice').textContent = `${currencyInfo.symbol}${unitPrice.toLocaleString()}`;
            document.getElementById('displayTotal').textContent = `${currencyInfo.symbol}${total.toLocaleString()}`;
            
            // Update wholesale pricing display
            const bulkPrice = hasDecimals 
                ? parseFloat((basePrice * 0.50).toFixed(2))
                : Math.round(basePrice * 0.50);
            document.getElementById('bulkPrice').textContent = `${currencyInfo.symbol}${bulkPrice.toLocaleString()}`;
            document.getElementById('retailPrice').textContent = `${currencyInfo.symbol}${basePrice.toLocaleString()}`;
            
            // Update example profit calculation (using 10 codes as example)
            const exampleQuantity = 10;
            const exampleBuyPrice = bulkPrice;
            const exampleSellPrice = basePrice; // Sell at full retail price for maximum profit
            const buyCost = exampleQuantity * exampleBuyPrice;
            const sellRevenue = exampleQuantity * exampleSellPrice;
            const profit = sellRevenue - buyCost;
            
            document.getElementById('exampleBuyPrice').textContent = `${currencyInfo.symbol}${exampleBuyPrice.toLocaleString()}`;
            document.getElementById('exampleBuyCost').textContent = `${currencyInfo.symbol}${buyCost.toLocaleString()}`;
            document.getElementById('exampleSellPrice').textContent = `${currencyInfo.symbol}${exampleSellPrice.toLocaleString()}`;
            document.getElementById('exampleSellRevenue').textContent = `${currencyInfo.symbol}${sellRevenue.toLocaleString()}`;
            document.getElementById('exampleProfit').textContent = `${currencyInfo.symbol}${profit.toLocaleString()}`;
            
            // Save currency preference
            saveCurrencyPreference(currencyCode);
        }

        async function proceedToBulkPayment() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const currency = document.getElementById('currencySelect').value || 'PHP';

            // Validation
            if (quantity < 10) {
                alert('Minimum purchase is 10 codes');
                return;
            }

            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            if (!phone) {
                alert('Please enter your mobile number');
                return;
            }

            try {
                const response = await fetch('/api/bulk/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity, email, phone, currency })
                });

                const data = await response.json();

                if (!data.success) {
                    alert(data.error || 'Failed to create bulk purchase');
                    return;
                }

                // Redirect to payment link
                window.location.href = data.paymentLink;

            } catch (error) {
                console.error('Bulk purchase error:', error);
                alert('An error occurred. Please try again.');
            }
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            // Priority: URL param > saved preference > auto-detect from locale
            const urlParams = new URLSearchParams(window.location.search);
            const urlCurrency = urlParams.get('currency');
            const saved = getSavedCurrency();
            const detected = urlCurrency || saved || detectCurrencyFromLocale();
            
            const currencySelect = document.getElementById('currencySelect');
            if (currencySelect && detected) {
                currencySelect.value = detected;
                const source = urlCurrency ? 'from main page' : (saved ? 'loaded from preference' : 'auto-detected');
                console.log(`ğŸ’° Currency ${source}: ${detected}`);
            }
            
            updateBulkPrice();
        });
    </script>
</body>
</html>
